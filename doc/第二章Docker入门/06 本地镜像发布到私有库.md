本地镜像发布到私有库流程：

![image-20240407130349997](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614452.png)

# 将本地镜像推送到私有库

## 1.下载镜像Docker Registry

Docker Registry是官方提供的工具，用于构建私有Docker镜像仓库的镜像。

```shell
docker pull registry
```

![image-20240407140410284](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614929.png)

## 2.运行私有库Registry

相当于本地有个私有Docker hub

```shell
docker run -d -p 5000:5000  -v /dongguo/myregistry/:/tmp/registry --privileged=true registry
```

- -p 5000:5000  主机端口映射：容器端口映射

- `-v /dongguo/myregistry/:/tmp/registry`: 这是容器卷（volume）映射参数，这里指定了映射到/tmp/registry  ； 

  默认情况，仓库被创建在容器的/var/lib/registry目录下，建议自行用容器卷映射，方便于宿主机联调

- --privileged=true 以特权模式运行容器。在特权模式下，容器内的进程拥有几乎和宿主机上的进程相同的权限，可以执行一些需要更高权限的操作。

- `registry`: 这是要运行的镜像名称，也就是Docker Hub上的官方Docker Registry镜像。

![image-20240407141101293](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614528.png)

## 3.创建一个新镜像

### 原始的Ubuntu镜像是不带着ifconfig命令的

![image-20240407141522876](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614756.png)

### 安装ifconfig命令并测试通过

docker容器内执行上述两条命令：

```shell
apt-get update

apt-get install net-tools
```

再次查看ip

![image-20240407141619541](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614739.png)

### 安装完成后，commit我们自己的新镜像

公式：

```shell
docker commit -m="提交的描述信息" -a="作者" 容器ID 要创建的目标镜像名:[标签名]
```

在容器外执行，可以新开一个会话执行

```shell
docker commit -m="ifconfig cmd add" -a="dongguo" edb0dcabfa39 dongguoubuntu:1.1.0
```

![image-20240407153929069](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614967.png)

### 启动新镜像

执行ifconfig

![image-20240407154017427](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614174.png)

## 4.curl验证私服库上有什么镜像

```shell
curl -XGET http://192.168.122.140:5000/v2/_catalog
```

- 192.168.122.140为对应linux主机的ip
- 5000：Docker Registry 使用的 5000 端口。

- `/v2/_catalog`: 这是 Docker Registry API 的一个端点，用于列出 registry 中可用的所有仓库（repositories）。

可以看到，目前私服库没有任何镜像发布

![image-20240407154254191](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614665.png)

## 5.将新镜像dongguoubuntu:1.1.0修改符合私服规范的Tag

按照公式：

```shell
docker   tag   镜像:Tag   Host:Port/Repository:Tag
```

使用命令 docker tag 将dongguoubuntu:1.1.0 这个镜像修改为192.168.122.140:5000/dongguoubuntu:1.1.0

```shell
docker tag  dongguoubuntu:1.1.0 192.168.122.140:5000/dongguoubuntu:1.1.0
```

![image-20240407154636057](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614503.png)

## 6.修改配置文件使之支持http

docker默认不允许http方式推送镜像，通过配置选项来取消这个限制

修改完后建议重启docker

### 编辑daemon.json

```shell
vim /etc/docker/daemon.json
```

registry-mirrors是之前配置的阿里云镜像加速

insecure-registries 配置一个或多个非安全的镜像仓库地址，这意味着Docker客户端在连接这些仓库时，将忽略SSL证书认证，从而可能使连接变得不安全。因此，这个配置选项一般仅用于隔离的测试环境或完全可控的环境，如公司内部测试环境，以避免可能的安全风险。

```json
{
  "registry-mirrors": ["https://vpmkvcwz.mirror.aliyuncs.com"],
  "insecure-registries": ["192.168.122.140:5000"]
}

```

### 查看daemon.json

```shell
cat /etc/docker/daemon.json
```

![image-20240407155944631](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614399.png)

### 重启docker

```shell
systemctl restart docker
```

### 启动私服仓库

```shell
docker run -d -p 5000:5000  -v /dongguo/myregistry/:/tmp/registry --privileged=true registry
```

![image-20240407160047035](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614542.png)

## 7.镜像push将推送到私服库

```shell
docker push 192.168.122.140:5000/dongguoubuntu:1.1.0
```

![image-20240407160202836](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614668.png)

## 8.curl再次验证私服库上的镜像

```shell
curl -XGET http://192.168.122.140:5000/v2/_catalog
```

![image-20240407160245047](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614946.png)

# 将私服库上的镜像下载到本地

## 1删除本地镜像 192.168.122.140:5000/dongguoubuntu

```
docker rmi -f b29ae4619ffb
```

![image-20240407160448901](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614875.png)

## 2.将私服库上的镜像下载到本地

```shell
docker pull 192.168.122.140:5000/dongguoubuntu:1.1.0
```

![image-20240407160627518](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614066.png)

## 3.启动下载到本地的镜像

```shell
docker run -it 0d9a6479e162 /bin/bash
```

ifconfig命令时可用的

![image-20240407160732558](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404071614088.png)

